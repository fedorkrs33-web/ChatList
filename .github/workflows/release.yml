name: Build and Release ChatList

on:
  release:
    types: [published]  # Запуск при публикации релиза

jobs:
  build-and-release:
    name: Build EXE and Installer
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyqt6 requests python-dotenv pyinstaller

    - name: Build EXE with PyInstaller
      run: |
        python -m PyInstaller ^
          --name "ChatList_v{{ '{{' }} github.event.release.tag_name.slice(1) {{ '}}' }}" ^
          --windowed ^
          --icon=app.ico ^
          --add-data ".env.example;." ^
          --add-data "app.ico;." ^
          --onefile ^
          main.py
      shell: cmd

    - name: Install Inno Setup
      run: |
        choco install innosetup -y
      shell: cmd

    - name: Generate version file for installer
      run: |
        python -c "
        version = '${{ github.event.release.tag_name }}'.lstrip('v')
        with open('version_info.txt', 'w') as f:
            f.write(f'# UTF-8\\nVSVersionInfo(\\n  ffi=FixedFileInfo(\\n    filevers=({version.replace('.', ', ')}, 0),\\n    prodvers=({version.replace('.', ', ')}, 0),\\n    mask=0x3f,\\n    flags=0x0,\\n    OS=0x40004,\\n    fileType=0x1,\\n    subtype=0x0,\\n    date=(0, 0)\\n  ),\\n  kids=[\\n    StringFileInfo([\\n      StringTable(u''041904B0'', [\\n        StringStruct(u''FileDescription'', u''ChatList — Сравнение AI-ответов''),\\n        StringStruct(u''ProductName'', u''ChatList''),\\n        StringStruct(u''ProductVersion'', u''{version}''),\\n        StringStruct(u''FileVersion'', u''{version}'')\\n      ])\\n    ])\\n  ]\\n)')
        "
      shell: cmd

    - name: Build Installer with Inno Setup
      run: |
        echo Generating installer script...
        echo [Setup] > installer.iss
        echo AppName=ChatList >> installer.iss
        echo AppVersion=${{ github.event.release.tag_name.slice(1) }} >> installer.iss
        echo DefaultDirName={autopf}\ChatList >> installer.iss
        echo OutputDir=dist >> installer.iss
        echo OutputBaseFilename=ChatList_Installer_v${{ github.event.release.tag_name.slice(1) }} >> installer.iss
        echo Compression=lzma >> installer.iss
        echo SolidCompression=yes >> installer.iss
        echo SetupIconFile=app.ico >> installer.iss
        echo UninstallDisplayIcon=app.ico >> installer.iss
        echo WizardImageFile=compiler:WizModernImage-IS.bmp >> installer.iss
        echo WizardSmallImageFile=compiler:WizModernSmallImage-IS.bmp >> installer.iss
        echo ShowLanguageDialog=yes >> installer.iss
        >> installer.iss
        echo [Languages] >> installer.iss
        echo Name: "ru"; MessagesFile: "compiler:Languages\Russian.isl" >> installer.iss
        >> installer.iss
        echo [Files] >> installer.iss
        echo Source: "dist\ChatList_v${{ github.event.release.tag_name.slice(1) }}.exe"; DestDir: "{app}"; Flags: ignoreversion >> installer.iss
        echo Source: ".env.example"; DestDir: "{app}" >> installer.iss
        echo Source: "README.md"; DestDir: "{app}" >> installer.iss
        echo Source: "app.ico"; DestDir: "{app}" >> installer.iss
        >> installer.iss
        echo [Icons] >> installer.iss
        echo Name: "{group}\ChatList"; Filename: "{app}\ChatList_v${{ github.event.release.tag_name.slice(1) }}.exe"; IconFilename: "{app}\app.ico" >> installer.iss
        echo Name: "{commondesktop}\ChatList"; Filename: "{app}\ChatList_v${{ github.event.release.tag_name.slice(1) }}.exe"; IconFilename: "{app}\app.ico"; Tasks: desktopicon >> installer.iss
        >> installer.iss
        echo [Run] >> installer.iss
        echo Filename: "{app}\ChatList_v${{ github.event.release.tag_name.slice(1) }}.exe"; Description: "Запустить ChatList"; Flags: nowait postinstall skipifsilent >> installer.iss
        iscc installer.iss
      shell: cmd

    - name: Upload artifacts to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: |
          dist/ChatList_v*.exe
          dist/ChatList_Installer_v*.exe
        tag: ${{ github.event.release.tag_name }}
        overwrite: true
