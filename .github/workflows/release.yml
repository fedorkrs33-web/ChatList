name: Build and Release ChatList

on:
  release:
    types: [published]

jobs:
  build:
    name: Build EXE & Installer (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python 3.14
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'

    - name: Install dependencies
      run: |
        pip install pyqt6 requests python-dotenv pyinstaller

    - name: Extract version (remove 'v' prefix)
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $env:GITHUB_ENV
        echo "VERSION_NO_V=${{ github.ref }}".Replace('refs/tags/v', '') >> $env:GITHUB_ENV
      shell: powershell

    - name: Build EXE with PyInstaller
      run: |
        python -m PyInstaller ^
          --name "ChatList_v$env:VERSION_NO_V" ^
          --windowed ^
          --icon=app.ico ^
          --add-data ".env.example;." ^
          --add-data "app.ico;." ^
          --onefile ^
          main.py
      shell: cmd

    - name: Install Inno Setup
      run: |
        choco install innosetup -y --no-progress
      shell: cmd

    - name: Generate installer script
      run: |
        $version = "$env:VERSION_NO_V"
        Write-Host "Версия: $version"
        Write-Host "Создаём installer.iss..."

        $iss = @"
        [Setup]
        AppName=ChatList
        AppVersion=$version
        DefaultDirName={autopf}\ChatList
        OutputDir=dist
        OutputBaseFilename=ChatList_Installer_v$version
        Compression=lzma
        SolidCompression=yes
        SetupIconFile=app.ico
        UninstallDisplayIcon=app.ico
        WizardImageFile=compiler:WizModernImage-IS.bmp
        WizardSmallImageFile=compiler:WizModernSmallImage-IS.bmp
        ShowLanguageDialog=yes

        [Languages]
        Name: "ru"; MessagesFile: "compiler:Languages\Russian.isl"

        [Files]
        Source: "dist\ChatList_v$version.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: ".env.example"; DestDir: "{app}"
        Source: "README.md"; DestDir: "{app}"
        Source: "app.ico"; DestDir: "{app}"

        [Icons]
        Name: "{group}\ChatList"; Filename: "{app}\ChatList_v$version.exe"
        Name: "{commondesktop}\ChatList"; Filename: "{app}\ChatList_v$version.exe"; Tasks: desktopicon

        [Run]
        Filename: "{app}\ChatList_v$version.exe"; Description: "Запустить после установки"; Flags: nowait postinstall
        "@
        $iss | Out-File -FilePath "installer.iss" -Encoding UTF8
        Get-Content installer.iss

        Write-Host "Запускаем ISCC..."
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
      shell: powershell

    - name: Upload artifacts to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: |
          dist/ChatList_v*.exe
          dist/ChatList_Installer_v*.exe
        tag: ${{ github.ref }}
        overwrite: true

